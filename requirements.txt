// --- BLYNK ve WiFi Kütüphaneleri ---
#define BLYNK_PRINT Serial // Blynk loglarını Seri Monitörde görmek için
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>

// --- Diğer Gerekli Kütüphaneler ---
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <OneWire.h>
#include <DallasTemperature.h>

// --- BLYNK AYARLARI (BURAYI DOLDUR!) ---
// Blynk Template ID ve Auth Token'ı Blynk uygulamasından al
#define BLYNK_TEMPLATE_ID "TMPL6buMGOngY"
#define BLYNK_TEMPLATE_NAME "aaa"
char auth[] = "xFw5njzTyyHw4Gj95vRzUWnwTxVIv27j";

// --- Wi-Fi AYARLARI (BURAYI DOLDUR!) ---
char ssid[] = "Realme 6";
char pass[] = "87654321";


// --- Pin Tanımlamaları (ESP32) ---
const int trigPin = 17;
const int echoPin = 18;
const int oneWireBus = 4;
const int ldrPin = 5;

// --- OLED Ekran Ayarları ---
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// --- Sensör Kurulumları ---
OneWire oneWire(oneWireBus);
DallasTemperature sensors(&oneWire);

// --- Zamanlayıcı Ayarları (Blynk için NON-BLOCKING) ---
unsigned long lastSensorReadTime = 0;
const long sensorReadInterval = 2000; // 2 saniyede bir sensörleri oku


void setup() {
  Serial.begin(115200);

  // OLED Ekranı Başlat
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 başlatılamadı"));
    for (;;);
  }
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println("Sera Sistemi Basliyor...");
  display.display();

  // Sensör Pinlerini Ayarla
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(ldrPin, INPUT);

  // DS18B20 Sensörünü Başlat
  sensors.begin();

  // Blynk ve Wi-Fi Bağlantısı
  display.println("WiFi'ye baglaniyor...");
  display.display();
  Serial.println("WiFi'ye baglaniyor...");

  // Blynk.begin() Wi-Fi'ye bağlanır ve Blynk sunucusuna giriş yapar
  Blynk.begin(auth, ssid, pass); 
  
  Serial.println("Baglanti Basarili!");
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("Blynk'e Baglandi!");
  display.display();
  delay(1000); // Sadece başlangıçta kısa bir bekleme
}


/**
 * @brief loop() ana döngüsü. Blynk'i çalıştırır ve zamanlayıcıyı kontrol eder.
 */
void loop() {
  Blynk.run(); // Blynk bağlantısını sürekli aktif tut (ASLA DELAY KULLANMA)

  // Zamanlayıcı kontrolü: Son okumadan bu yana 2 saniye geçti mi?
  if (millis() - lastSensorReadTime >= sensorReadInterval) {
    lastSensorReadTime = millis(); // Zamanlayıcıyı sıfırla
    readSensorsAndSend(); // Tüm sensörleri okuma, OLED ve Blynk'e yollama işini yap
  }
}

/**
 * @brief Tüm sensörleri okur, OLED'i günceller ve Blynk'e veri yollar.
 */
void readSensorsAndSend() {
  // 1. Su Seviyesini Oku
  int distance = getWaterDistance();
  String waterStatusOLED = getWaterStatus(distance); // OLED için metin
  int waterPercent = getWaterPercentage(distance);   // Blynk için sayı (%)

  // 2. Sıcaklığı Oku
  float temperatureC = getTemperature();

  // 3. Işık Durumunu Oku
  String lightStatus = getLightStatus();

  // 4. Değerleri OLED Ekrana Yazdır
  updateOLED(waterStatusOLED, temperatureC, lightStatus);

  // 5. Değerleri BLYNK Sanal Pinlerine Gönder
  Blynk.virtualWrite(V0, waterPercent); // Su yüzdesini V0'a yolla
  Blynk.virtualWrite(V1, temperatureC); // Sıcaklığı V1'e yolla
  Blynk.virtualWrite(V2, lightStatus);  // Işık durumunu V2'ye yolla

  // 6. Değerleri Seri Monitöre de yazdıralım
  Serial.print("Mesafe: "); Serial.print(distance); Serial.print(" cm");
  Serial.print(" | Yuzde: "); Serial.print(waterPercent); Serial.print(" %");
  Serial.print(" | Sicaklik: "); Serial.print(temperatureC); Serial.print(" C");
  Serial.print(" | Ortam: "); Serial.println(lightStatus);
}


// --- Fonksiyonlar (Aşağıdakiler değişmedi) ---

int getWaterDistance() {
  digitalWrite(trigPin, LOW); delayMicroseconds(2);
  digitalWrite(trigPin, HIGH); delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  long duration = pulseIn(echoPin, HIGH, 25000);
  if (duration > 0) {
    int distance = duration * 0.0343 / 2;
    return distance;
  }
  return -1;
}

String getWaterStatus(int distance) {
  if (distance < 0) { return "Sensor Hatasi"; }
  else if (distance >= 25) { return "SU BITTI!"; }
  else if (distance >= 20) { return "Su: ~%0 (Kritik)"; }
  else if (distance >= 15) { return "Su: ~%20"; }
  else if (distance >= 10) { return "Su: ~%40"; }
  else if (distance >= 5) { return "Su: ~%60"; }
  else { return "Su: ~%80"; }
}

float getTemperature() {
  sensors.requestTemperatures();
  float tempC = sensors.getTempCByIndex(0);
  if (tempC == DEVICE_DISCONNECTED_C) {
    Serial.println("DS18B20 Hata!");
    return -99.0;
  }
  return tempC;
}

String getLightStatus() {
  int durum = digitalRead(ldrPin);
  if (durum == HIGH) { return "Karanlik"; }
  else { return "Aydinlik"; }
}

void updateOLED(String water, float temp, String light) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);   display.println(water);
  display.setCursor(0, 16);  display.print("Ortam: "); display.println(light);
  display.setCursor(0, 32);  display.print("Sicaklik: "); display.print(temp, 1); display.println(" C");
  display.setCursor(0, 48);  display.print("Nem: --"); // Burası hala boş :)
  display.display();
}

// --- BLYNK İÇİN YENİ FONKSİYON ---

/**
 * @brief Blynk'e sayısal yüzde yollamak için mesafeyi %'ye çevirir.
 * @param distance Ölçülen mesafe (cm)
 * @return Yüzde (0-100 arası, kabaca)
 */
int getWaterPercentage(int distance) {
  if (distance < 0) { return 0; }
  else if (distance >= 25) { return 0; }
  else if (distance >= 20) { return 0; }
  else if (distance >= 15) { return 20; }
  else if (distance >= 10) { return 40; }
  else if (distance >= 5) { return 60; }
  else { return 80; } // 0-5cm arasını %80 kabul ettik (istersen 100 yap)
}